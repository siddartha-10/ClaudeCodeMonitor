name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (leave empty to use tauri.conf.json version)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  build_macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install CMake
        run: brew install cmake openssl@3

      - name: Install dependencies
        run: npm ci

      - name: Build app bundle (unsigned)
        run: npm run tauri -- build --bundles app

      - name: Bundle OpenSSL (unsigned)
        run: |
          set -euo pipefail
          app_path="src-tauri/target/release/bundle/macos/ClaudeCodeMonitor.app"

          openssl_prefix="$(brew --prefix openssl@3)"
          libssl="${openssl_prefix}/lib/libssl.3.dylib"
          libcrypto="${openssl_prefix}/lib/libcrypto.3.dylib"
          frameworks_dir="${app_path}/Contents/Frameworks"
          bin_path="${app_path}/Contents/MacOS/claude-code-monitor"

          mkdir -p "${frameworks_dir}"
          cp -f "${libssl}" "${frameworks_dir}/"
          cp -f "${libcrypto}" "${frameworks_dir}/"

          install_name_tool -id "@rpath/libssl.3.dylib" "${frameworks_dir}/libssl.3.dylib"
          install_name_tool -id "@rpath/libcrypto.3.dylib" "${frameworks_dir}/libcrypto.3.dylib"

          # Fix libssl's reference to libcrypto
          install_name_tool -change "${libcrypto}" "@rpath/libcrypto.3.dylib" "${frameworks_dir}/libssl.3.dylib" 2>/dev/null || true

          # Fix binary's references
          install_name_tool -change "${libssl}" "@rpath/libssl.3.dylib" "${bin_path}" 2>/dev/null || true
          install_name_tool -change "${libcrypto}" "@rpath/libcrypto.3.dylib" "${bin_path}" 2>/dev/null || true

          # Add rpath if not present
          if ! otool -l "${bin_path}" | grep -q "@executable_path/../Frameworks"; then
            install_name_tool -add_rpath "@executable_path/../Frameworks" "${bin_path}"
          fi

          # Ad-hoc sign (required for macOS to run, but not notarized)
          codesign --force --deep --sign - "${app_path}"

          echo "Bundled OpenSSL and ad-hoc signed ${app_path}"

      - name: Package artifacts
        run: |
          set -euo pipefail
          VERSION=$(python3 - <<'PY'
          import json
          from pathlib import Path

          data = json.loads(Path("src-tauri/tauri.conf.json").read_text())
          print(data["version"])
          PY
          )

          mkdir -p release-artifacts release-artifacts/dmg-root
          ditto src-tauri/target/release/bundle/macos/ClaudeCodeMonitor.app \
            release-artifacts/dmg-root/ClaudeCodeMonitor.app

          # Create ZIP
          ditto -c -k --keepParent \
            src-tauri/target/release/bundle/macos/ClaudeCodeMonitor.app \
            release-artifacts/ClaudeCodeMonitor_${VERSION}_macos_aarch64.zip

          # Create DMG
          hdiutil create -volname "ClaudeCodeMonitor" \
            -srcfolder release-artifacts/dmg-root \
            -ov -format UDZO \
            release-artifacts/ClaudeCodeMonitor_${VERSION}_macos_aarch64.dmg

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: release-artifacts/ClaudeCodeMonitor_*

  build_linux:
    name: appimage (${{ matrix.arch }})
    runs-on: ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-22.04
            arch: x86_64
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake libwebkit2gtk-4.1-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev patchelf libfuse2 xdg-utils libasound2-dev

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: npm

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build AppImage
        run: npm run tauri -- build --bundles appimage

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: appimage-${{ matrix.arch }}
          path: src-tauri/target/release/bundle/appimage/*.AppImage

  release:
    runs-on: ubuntu-latest
    needs:
      - build_macos
      - build_linux
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-artifacts
          path: release-artifacts

      - name: Download Linux AppImages
        uses: actions/download-artifact@v4
        with:
          pattern: appimage-*
          path: release-artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la release-artifacts/

      - name: Build release notes
        run: |
          set -euo pipefail
          VERSION=$(python3 - <<'PY'
          import json
          from pathlib import Path

          data = json.loads(Path("src-tauri/tauri.conf.json").read_text())
          print(data["version"])
          PY
          )

          LAST_TAG=$(git tag --sort=-version:refname \
            | grep -v "^v${VERSION}$" \
            | head -n 1 || true)

          if [ -n "$LAST_TAG" ]; then
            git log "${LAST_TAG}..HEAD" --pretty=format:"%s" > release-commits.txt
          else
            git log HEAD --pretty=format:"%s" > release-commits.txt
          fi

          python3 - <<'PY'
          import re
          from pathlib import Path

          lines = Path("release-commits.txt").read_text().splitlines()
          pattern = re.compile(r"^(feat|fix|perf)(?:\([^)]*\))?:\s*(.+)$", re.IGNORECASE)
          groups = {"feat": [], "fix": [], "perf": []}

          for line in lines:
              match = pattern.match(line.strip())
              if not match:
                  continue
              kind = match.group(1).lower()
              message = match.group(2).strip()
              if message:
                  groups[kind].append(message)

          sections = [
              ("## New Features", "feat"),
              ("## Bug Fixes", "fix"),
              ("## Performance", "perf"),
          ]

          output = ["## ClaudeCodeMonitor Release", ""]
          output.append("> **Note**: This is an unsigned release. macOS users may need to right-click â†’ Open or run `xattr -cr /Applications/ClaudeCodeMonitor.app` to bypass Gatekeeper.")
          output.append("")

          has_changes = False
          for title, key in sections:
              items = groups[key]
              if not items:
                  continue
              has_changes = True
              output.append(title)
              output.extend([f"- {item}" for item in items])
              output.append("")

          if not has_changes:
              output.append("## Changes")
              output.append("- Various improvements and fixes")
              output.append("")

          output.append("## Installation")
          output.append("- **macOS (Apple Silicon)**: Download the `.dmg` or `.zip` file")
          output.append("- **Linux**: Download the `.AppImage` file and make it executable (`chmod +x`)")
          output.append("")

          Path("release-notes.md").write_text("\n".join(output))
          PY

      - name: Create GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          VERSION=$(python3 - <<'PY'
          import json
          from pathlib import Path

          data = json.loads(Path("src-tauri/tauri.conf.json").read_text())
          print(data["version"])
          PY
          )

          gh release create "v${VERSION}" \
            --title "v${VERSION}" \
            --notes-file release-notes.md \
            --target "$GITHUB_SHA" \
            release-artifacts/*

      - name: Bump version and open PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          VERSION=$(python3 - <<'PY'
          import json
          from pathlib import Path

          data = json.loads(Path("src-tauri/tauri.conf.json").read_text())
          print(data["version"])
          PY
          )

          NEXT_VERSION=$(python3 - <<'PY' "$VERSION"
          import sys

          version = sys.argv[1]
          parts = version.split(".")
          if len(parts) != 3:
              raise SystemExit("Expected version like 0.X.Y")

          major, minor, patch = (int(p) for p in parts)
          print(f"{major}.{minor}.{patch + 1}")
          PY
          )

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          npm version "$NEXT_VERSION" --no-git-tag-version

          python3 - <<PY
          import json
          from pathlib import Path

          path = Path("src-tauri/tauri.conf.json")
          data = json.loads(path.read_text())
          data["version"] = "$NEXT_VERSION"
          path.write_text(json.dumps(data, indent=2) + "\n")
          PY

          git checkout -b "chore/bump-version-${NEXT_VERSION}"
          git add package.json package-lock.json src-tauri/tauri.conf.json
          git commit -m "chore: bump version to ${NEXT_VERSION}"
          git push origin "chore/bump-version-${NEXT_VERSION}"

          gh pr create \
            --title "chore: bump version to ${NEXT_VERSION}" \
            --body "Post-release version bump to ${NEXT_VERSION}." \
            --base main \
            --head "chore/bump-version-${NEXT_VERSION}"
